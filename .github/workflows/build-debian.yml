name: Build Debian/Ubuntu

on:
  workflow_dispatch:
  workflow_call:

env:
  BUILD_DEPS: "g++ make lsb-release libboost-dev libtiff-dev catch2"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        container:
          - image: "debian:bookworm-slim"
            name: "Debian.bookworm"
          - image: "debian:trixie-slim"
            name: "Debian.trixie"
          - image: "ubuntu:24.04"
            name: "Ubuntu.noble"
          - image: "ubuntu:22.04"
            name: "Ubuntu.jammy"
    
    container:
      image: ${{ matrix.container.image }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Install Dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update -qq
          apt-get install -y --no-install-recommends ${{ env.BUILD_DEPS }}

      - name: Get Environment Info
        id: env_info
        run: |
          DISTRIBUTION=$(lsb_release --short --id 2>/dev/null)
          CODENAME=$(lsb_release --short --codename 2>/dev/null)
          MACHINE=$(uname --machine 2>/dev/null)
          SUFFIX=".${DISTRIBUTION}.${CODENAME}.${MACHINE}"
          echo "suffix=${SUFFIX}" >> $GITHUB_OUTPUT
          echo "Building for: ${DISTRIBUTION} ${CODENAME} (${MACHINE})"

      - name: Check Package Versions
        run: |
          SUFFIX="${{ steps.env_info.outputs.suffix }}"
          dpkg-query -W -f='${binary:Package} ${Version}\n' ${{ env.BUILD_DEPS }} > "pkgs${SUFFIX}.txt"
          cat "pkgs${SUFFIX}.txt"

      - name: Bump Version in Code
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
          else
            version="${{ github.sha }}"
          fi
          echo "Setting version to ${version}"
          sed -i "s/C2FW_VERSION.*/C2FW_VERSION = \"${version}\";/" Cell2Fire/Cell2Fire.h

      - name: Build
        run: |
          cd Cell2Fire
          make clean
          make

      - name: Build & Run Unit Tests
        run: |
          cd Cell2Fire
          make tests

      - name: Get Binary Info
        run: |
          SUFFIX="${{ steps.env_info.outputs.suffix }}"
          cd Cell2Fire
          ldd Cell2Fire > "ldd${SUFFIX}.txt"
          cat "ldd${SUFFIX}.txt"

      - name: Prepare Artifacts
        run: |
          SUFFIX="${{ steps.env_info.outputs.suffix }}"
          cd Cell2Fire
          mv Cell2Fire "Cell2Fire${SUFFIX}"
          ls -lh "Cell2Fire${SUFFIX}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: binaries${{ steps.env_info.outputs.suffix }}
          path: |
            Cell2Fire/Cell2Fire${{ steps.env_info.outputs.suffix }}
            Cell2Fire/ldd${{ steps.env_info.outputs.suffix }}.txt
            pkgs${{ steps.env_info.outputs.suffix }}.txt
          if-no-files-found: error
