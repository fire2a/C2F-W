<<<<<<< HEAD
name: build macos all

||||||| parent of dad7e72a (tidy macOS workflow)
name: Build macOS

=======
---
<<<<<<< HEAD
name: Build macOS
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
name: Build macOS
=======
name: Build macOS (dynamic & static lib.linking)
>>>>>>> 4d668e09 (macOS build fixes)
on:
  # pull_request:
  #   branches:
  #     - main
  workflow_dispatch:
  workflow_call:
permissions:
  contents: write
jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
<<<<<<< HEAD
        runner: [ "macOS-13", "macOS-14" ]
||||||| parent of dad7e72a (tidy macOS workflow)
        include:
          # ARM64 builds on macOS 14 Sonoma
          - runner: macos-14
            arch: arm64
            type: dynamic
          - runner: macos-14
            arch: arm64
            type: static
          # ARM64 builds on macOS 15 Sequoia
          - runner: macos-15
            arch: arm64
            type: dynamic
          - runner: macos-15
            arch: arm64
            type: static
          # Intel x86_64 builds on macOS 15
          - runner: macos-15-intel
            arch: x86_64
            type: dynamic
          - runner: macos-15-intel
            arch: x86_64
            type: static
    
=======
        include:
          # ARM64 builds on macOS 14 Sonoma
          - runner: macos-14
            arch: arm64
            type: dynamic
          - runner: macos-14
            arch: arm64
            type: static
          # ARM64 builds on macOS 15 Sequoia
          - runner: macos-15
            arch: arm64
            type: dynamic
          - runner: macos-15
            arch: arm64
            type: static
          # Intel x86_64 builds on macOS 15
          - runner: macos-15-intel
            arch: x86_64
            type: dynamic
          - runner: macos-15-intel
            arch: x86_64
            type: static
>>>>>>> dad7e72a (tidy macOS workflow)
    runs-on: ${{ matrix.runner }}
    continue-on-error: true
    steps:
      - name: Checkout Code
<<<<<<< HEAD
<<<<<<< HEAD
        uses: actions/checkout@v6

      - name: Bump version in code
||||||| parent of dad7e72a (tidy macOS workflow)
        uses: actions/checkout@v5

      - name: Install gsed for version bumping
        run: brew install gsed

      - name: Bump Version in Code
=======
        uses: actions/checkout@v5
||||||| parent of 4d668e09 (macOS build fixes)
        uses: actions/checkout@v5
=======
        uses: actions/checkout@v6
>>>>>>> 4d668e09 (macOS build fixes)
      - name: Install gsed for version bumping
        run: brew install gsed
      - name: Bump Version in Code
>>>>>>> dad7e72a (tidy macOS workflow)
        run: |
          brew install gsed
          run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version=${{ github.sha }}
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version=${{ github.sha }}
          fi  
          if [[ "${{github.event_name}}" == "push" && "${{github.ref_type}}" == "tag" ]]; then
            version=${{ github.ref_name }}
          fi
          gsed -i "s/C2FW_VERSION.*/C2FW_VERSION = \"${version}\";/" Cell2Fire/Cell2Fire.h
          grep C2FW_VERSION Cell2Fire/Cell2Fire.h
<<<<<<< HEAD

      - name: Check Runner
||||||| parent of dad7e72a (tidy macOS workflow)

      - name: Set Environment
=======
      - name: Set Environment
>>>>>>> dad7e72a (tidy macOS workflow)
        run: |
<<<<<<< HEAD
          # arch
          # echo "runner: ${{ matrix.runner }}.$(arch).$(uname -m)"
          # mayor version: sw_vers -productVersion | cut -d '.' -f 1
          # Darwin : uname -s
          echo "suffix="$(uname -s).${{ matrix.runner }}.$(arch)"" >> $GITHUB_ENV
          brew config

||||||| parent of dad7e72a (tidy macOS workflow)
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV
          echo "Building for: ${KERNEL} on ${{ matrix.runner }} (${MACHINE})"

=======
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV
          echo "Building for: ${KERNEL} on ${{ matrix.runner }} (${MACHINE})"
<<<<<<< HEAD
          echo "matrix:: type:${{ matrix.type }}, arch:${{ matrix.arch }}, runner:${{ matrix.runner }}"
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
          echo "matrix:: type:${{ matrix.type }}, arch:${{ matrix.arch }}, runner:${{ matrix.runner }}"
=======
          echo "matrix attributes:: type:${{ matrix.type }}, arch:${{ matrix.arch }}, runner:${{ matrix.runner }}"
>>>>>>> 4d668e09 (macOS build fixes)
      - name: Install Dependencies
        run: |
<<<<<<< HEAD
          brew install gcc@12 libomp boost libtiff # llvm ?

||||||| parent of dad7e72a (tidy macOS workflow)
          brew install gcc libomp boost libtiff
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew install jpeg-turbo xz zstd zlib
          fi

      - name: Check Brew Package Versions
        run: |
          brew list --versions gcc libomp boost libtiff > "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew list --versions jpeg-turbo xz zstd zlib >> "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          fi
          cat "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"

=======
          brew install gcc libomp boost libtiff
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew install jpeg-turbo xz zstd zlib
          else
            brew install catch2
          fi
      - name: Check Brew Package Versions
        run: |
          brew list --versions gcc libomp boost libtiff > "Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew list --versions jpeg-turbo xz zstd zlib >> "Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          fi
<<<<<<< HEAD
          cat "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
>>>>>>> dad7e72a (tidy macOS workflow)
      - name: Build
||||||| parent of 4d668e09 (macOS build fixes)
          cat "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
      - name: Build
=======
          cat "Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
      - name: Debug show stuff
        if: true
        env:
          MATRIX_TYPE: ${{ matrix.type }}
        run: |
          set -x
          g++ --version
          which g++
          ls $(brew --prefix boost)
          ls $(brew --prefix libomp)
          ls $(brew --prefix libtiff)
          brew install tree 
          set +x
          function ls_brew_pkg() {
           pkg_name=$1
           pkg_prefix=$(brew --prefix $pkg_name)
           echo "Listing for $pkg_name at $pkg_prefix"
           # ls -lR "$pkg_prefix/lib" 2>/dev/null || echo "lib does not exist"
           # ls -lR "$pkg_prefix/include" 2>/dev/null || echo "include does not exist"
           tree -L 1 "$pkg_prefix/lib" || echo "Cannot tree $pkg_prefix"
           tree -L 1 "$pkg_prefix/include" || echo "Cannot tree $pkg_prefix"
          }
          # ls_brew_pkg boost
          ls_brew_pkg libomp
          ls_brew_pkg libtiff
          if [[ "$MATRIX_TYPE" == *dynamic* ]]; then 
            ls $(brew --prefix catch2)
            ls_brew_pkg catch2
            echo "catch2 v: $(brew list --versions catch2 | cut -d' ' -f2 | sort -V | tail -n1 | cut -d. -f1)"
          fi
          
      - name: Build (& Test if dynamic)
>>>>>>> 4d668e09 (macOS build fixes)
        run: |
          cd Cell2Fire
<<<<<<< HEAD
          make clean
<<<<<<< HEAD
          make -f makefile.macos
          otool -L Cell2Fire > otool_${{ env.suffix }}.txt
          mv Cell2Fire Cell2Fire_${{ env.suffix }}

      - name: Upload
||||||| parent of dad7e72a (tidy macOS workflow)
          if [[ "${{ matrix.type }}" == "static" ]]; then
            make -f makefile.macos-static
          else
            make -f makefile.macos
          fi

      - name: Get Binary Info
        run: |
          cd Cell2Fire
          otool -L Cell2Fire > "otool${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          cat "otool${{ env.SUFFIX }}-${{ matrix.type }}.txt"

      - name: Prepare Artifacts
        run: |
          cd Cell2Fire
          mv Cell2Fire "Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}"
          ls -lh "Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}"

      - name: Upload Artifacts
=======
||||||| parent of 4d668e09 (macOS build fixes)
          make clean
=======
>>>>>>> 4d668e09 (macOS build fixes)
          if [[ "${{ matrix.type }}" == "static" ]]; then
            make -f makefile.macos-static info
            make -f makefile.macos-static clean
            make -f makefile.macos-static
          else
            make -f makefile.macos info
            make -f makefile.macos clean
            make -f makefile.macos tests
            make -f makefile.macos
          fi
      - name: Get Binary Info
        run: |
          cd Cell2Fire
          otool -L Cell2Fire > "otool${{ env.SUFFIX }}.${{ matrix.type }}.txt"
          cat "otool${{ env.SUFFIX }}.${{ matrix.type }}.txt"
      - name: Prepare Artifacts
        run: |
          cd Cell2Fire
          mv Cell2Fire "Cell2Fire${{ env.SUFFIX }}.${{ matrix.type }}"
          ls -lh "Cell2Fire${{ env.SUFFIX }}.${{ matrix.type }}"
      - name: Upload Artifacts
>>>>>>> dad7e72a (tidy macOS workflow)
        uses: actions/upload-artifact@v5
        with:
          name: binaries_${{ env.suffix }}
          path: |
<<<<<<< HEAD
<<<<<<< HEAD
            Cell2Fire/otool_${{ env.suffix }}.txt
            Cell2Fire/Cell2Fire_${{ env.suffix }}

      - name: Install Static Dependencies
        run: |
          brew install gcc@12 libomp boost libtiff jpeg-turbo xz zstd zlib

      - name: Build Static
        run: |
          cd Cell2Fire
          make clean
          make -f makefile.macos-static
          otool -L Cell2Fire > otool_${{ env.suffix }}-static.txt
          mv Cell2Fire Cell2Fire_${{ env.suffix }}-static

      - name: Upload Static
        uses: actions/upload-artifact@v5
        with:
          name: binaries_${{ env.suffix }}-static
          path: |
            Cell2Fire/otool_${{ env.suffix }}-static.txt
            Cell2Fire/Cell2Fire_${{ env.suffix }}-static
||||||| parent of dad7e72a (tidy macOS workflow)
            Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
            Cell2Fire/otool${{ env.SUFFIX }}-${{ matrix.type }}.txt
            Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt
||||||| parent of 8089279f (build fixes)
            Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
            Cell2Fire/otool${{ env.SUFFIX }}-${{ matrix.type }}.txt
            Cell2Fire/pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt
=======
            Cell2Fire/Cell2Fire${{ env.SUFFIX }}.${{ matrix.type }}
            Cell2Fire/otool${{ env.SUFFIX }}.${{ matrix.type }}.txt
            Cell2Fire/pkgs${{ env.SUFFIX }}.${{ matrix.type }}.txt
>>>>>>> 8089279f (build fixes)
          if-no-files-found: error

=======
            Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
            Cell2Fire/otool${{ env.SUFFIX }}-${{ matrix.type }}.txt
            pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt
          if-no-files-found: error
>>>>>>> dad7e72a (tidy macOS workflow)
  test:
    needs: build
    strategy:
      fail-fast: false
      matrix:
<<<<<<< HEAD
<<<<<<< HEAD
        runner: [ "macOS-13", "macOS-14" ]
||||||| parent of dad7e72a (tidy macOS workflow)
        runner: [ macos-14, macos-15, macos-15-intel ]
    
=======
        runner:
          - macos-14
          - macos-15
          - macos-15-intel
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
        runner:
          - macos-14
          - macos-15
          - macos-15-intel
=======
        include:
          # ARM64 builds on macOS 14 Sonoma
          - runner: macos-14
            arch: arm64
            type: dynamic
          - runner: macos-14
            arch: arm64
            type: static
          # ARM64 builds on macOS 15 Sequoia
          - runner: macos-15
            arch: arm64
            type: dynamic
          - runner: macos-15
            arch: arm64
            type: static
          # Intel x86_64 builds on macOS 15
          - runner: macos-15-intel
            arch: x86_64
            type: dynamic
          - runner: macos-15-intel
            arch: x86_64
            type: static
>>>>>>> 4d668e09 (macOS build fixes)
    runs-on: ${{ matrix.runner }}
    continue-on-error: true
    steps:
      - name: Checkout Code
<<<<<<< HEAD
<<<<<<< HEAD
        uses: actions/checkout@v6

      - name: Install Dependencies
||||||| parent of dad7e72a (tidy macOS workflow)
        uses: actions/checkout@v5

      - name: Install Test Dependencies
=======
        uses: actions/checkout@v5
      - name: Install Test Dependencies
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
        uses: actions/checkout@v5
      - name: Install Test Dependencies
=======
        uses: actions/checkout@v6

      - name: Set Environment
>>>>>>> 4d668e09 (macOS build fixes)
        run: |
<<<<<<< HEAD
<<<<<<< HEAD
          brew install gcc@12 libomp boost libtiff

      - name: Get Environment
        run: |
          echo "suffix="$(uname -s).${{ matrix.runner }}.$(arch)"" >> $GITHUB_ENV

||||||| parent of dad7e72a (tidy macOS workflow)
          brew install gcc libomp boost

=======
          brew install gcc libomp boost
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
          brew install gcc libomp boost
=======
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV

>>>>>>> 4d668e09 (macOS build fixes)
      - name: Download Artifacts
        uses: actions/download-artifact@v6
        with:
<<<<<<< HEAD
          pattern: binaries_${{ env.suffix }}
||||||| parent of 4d668e09 (macOS build fixes)
          pattern: binaries*${{ matrix.runner }}*
=======
          name: binaries${{ env.SUFFIX }}-${{ matrix.type }}
>>>>>>> 4d668e09 (macOS build fixes)
          path: Cell2Fire
<<<<<<< HEAD
          merge-multiple: true
<<<<<<< HEAD

      - name: Cache Catch2 header
        uses: actions/cache@v4
        with:
          path: catch.hpp
          key: ${{ runner.os }}-catch2

      - name: Download Catch2 header
||||||| parent of dad7e72a (tidy macOS workflow)

      - name: Make Binaries Executable
=======
      - name: Make Binaries Executable
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
          merge-multiple: true
      - name: Make Binaries Executable
=======

      - name: Install Dependencies
        if: contains(matrix.type, 'dynamic')
>>>>>>> 4d668e09 (macOS build fixes)
        run: |
<<<<<<< HEAD
          BREW_PREFIX=$(brew --prefix)
          INCLUDE_DIR="$BREW_PREFIX/include/catch2"
          
          if [ ! -f "$INCLUDE_DIR/catch.hpp" ]; then
          mkdir -p "$INCLUDE_DIR"
          curl -L https://raw.githubusercontent.com/catchorg/Catch2/v2.x/single_include/catch2/catch.hpp -o "$INCLUDE_DIR/catch.hpp"
          fi

      - name: chmod
        run: |
          ls Cell2Fire
          chmod +x Cell2Fire/Cell2Fire*
<<<<<<< HEAD

      - name: Unit Test
||||||| parent of dad7e72a (tidy macOS workflow)

      - name: Build and Run Unit Tests
=======
      - name: Build and Run Unit Tests
>>>>>>> dad7e72a (tidy macOS workflow)
        run: |
          cd Cell2Fire
<<<<<<< HEAD
          make -f makefile.macos tests

#      - name: Bash Test
#        run: |
#          cd test
#          bash test.sh _${{ env.suffix }}
||||||| parent of dad7e72a (tidy macOS workflow)
          make tests
          ./test_cell2fire

      - name: Test Dynamic Binary
        run: |
          cd test
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-dynamic" ]]; then
            bash test.sh "${SUFFIX}-dynamic"
          fi

      - name: Test Static Binary
        run: |
          cd test
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-static" ]]; then
            bash test.sh "${SUFFIX}-static"
          fi
=======
          make tests
          ./test_cell2fire
||||||| parent of 4d668e09 (macOS build fixes)
          chmod +x Cell2Fire/Cell2Fire*
      - name: Build and Run Unit Tests
        run: |
          cd Cell2Fire
          make tests
          ./test_cell2fire
=======
          brew install libomp boost libtiff

>>>>>>> 4d668e09 (macOS build fixes)
      - name: Test Dynamic Binary
        run: |
          chmod +x Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
          cd test
<<<<<<< HEAD
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-dynamic" ]]; then
            bash test.sh "${SUFFIX}-dynamic"
          fi
      - name: Test Static Binary
        run: |-
          cd test
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-static" ]]; then
            bash test.sh "${SUFFIX}-static"
          fi
>>>>>>> dad7e72a (tidy macOS workflow)
||||||| parent of 4d668e09 (macOS build fixes)
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-dynamic" ]]; then
            bash test.sh "${SUFFIX}-dynamic"
          fi
      - name: Test Static Binary
        run: |-
          cd test
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-static" ]]; then
            bash test.sh "${SUFFIX}-static"
          fi
=======
          bash test.sh "${{ env.SUFFIX }}-${{ matrix.type }}"
>>>>>>> 4d668e09 (macOS build fixes)
