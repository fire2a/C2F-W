name: Build macOS

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        include:
          # ARM64 builds
          - runner: macos-15
            arch: arm64
            type: dynamic
          - runner: macos-15
            arch: arm64
            type: static
          # Intel x86_64 builds
          - runner: macos-14-large
            arch: x86_64
            type: dynamic
          - runner: macos-14-large
            arch: x86_64
            type: static
    
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Install gsed for version bumping
        run: brew install gsed

      - name: Bump Version in Code
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            version="${{ github.sha }}"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            version="${{ github.ref_name }}"
          else
            version="${{ github.sha }}"
          fi
          echo "Setting version to ${version}"
          gsed -i "s/C2FW_VERSION.*/C2FW_VERSION = \"${version}\";/" Cell2Fire/Cell2Fire.h
          grep C2FW_VERSION Cell2Fire/Cell2Fire.h

      - name: Set Environment
        run: |
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          echo "SUFFIX=${SUFFIX}" >> $GITHUB_ENV
          echo "Building for: ${KERNEL} on ${{ matrix.runner }} (${MACHINE})"

      - name: Install Dependencies
        run: |
          brew install gcc libomp boost libtiff
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew install jpeg-turbo xz zstd zlib
          fi

      - name: Check Brew Package Versions
        run: |
          brew list --versions gcc libomp boost libtiff > "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          if [[ "${{ matrix.type }}" == "static" ]]; then
            brew list --versions jpeg-turbo xz zstd zlib >> "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          fi
          cat "pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt"

      - name: Build
        run: |
          cd Cell2Fire
          make clean
          if [[ "${{ matrix.type }}" == "static" ]]; then
            make -f makefile.macos-static
          else
            make -f makefile.macos
          fi

      - name: Get Binary Info
        run: |
          cd Cell2Fire
          otool -L Cell2Fire > "otool${{ env.SUFFIX }}-${{ matrix.type }}.txt"
          cat "otool${{ env.SUFFIX }}-${{ matrix.type }}.txt"

      - name: Prepare Artifacts
        run: |
          cd Cell2Fire
          mv Cell2Fire "Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}"
          ls -lh "Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: binaries${{ env.SUFFIX }}-${{ matrix.type }}
          path: |
            Cell2Fire/Cell2Fire${{ env.SUFFIX }}-${{ matrix.type }}
            Cell2Fire/otool${{ env.SUFFIX }}-${{ matrix.type }}.txt
            pkgs${{ env.SUFFIX }}-${{ matrix.type }}.txt
          if-no-files-found: error

  test:
    needs: build
    strategy:
      matrix:
        runner: [ macos-15, macos-14-large ]
    
    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Install Test Dependencies
        run: |
          brew install gcc libomp boost

      - name: Download Artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: binaries*${{ matrix.runner }}*
          path: Cell2Fire
          merge-multiple: true

      - name: Make Binaries Executable
        run: |
          chmod +x Cell2Fire/Cell2Fire*

      - name: Build and Run Unit Tests
        run: |
          cd Cell2Fire
          make tests
          ./test_cell2fire

      - name: Test Dynamic Binary
        run: |
          cd test
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-dynamic" ]]; then
            bash test.sh "${SUFFIX}-dynamic"
          fi

      - name: Test Static Binary
        run: |
          cd test
          KERNEL=$(uname -s)
          MACHINE=$(uname -m)
          SUFFIX="_${KERNEL}.${{ matrix.runner }}.${MACHINE}"
          if [[ -f "../Cell2Fire/Cell2Fire${SUFFIX}-static" ]]; then
            bash test.sh "${SUFFIX}-static"
          fi
